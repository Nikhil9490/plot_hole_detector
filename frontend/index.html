<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AI Plot Hole Detector</title>
    <style>
      body { font-family: system-ui, Arial; margin: 20px; max-width: 1000px; }
      .row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
      input[type="text"] { width: 260px; padding: 10px; font-size: 14px; }
      textarea { width: 100%; height: 260px; padding: 12px; box-sizing: border-box; font-size: 14px; line-height: 1.35; }
      button { padding: 10px 14px; cursor: pointer; }
      .status { margin: 10px 0; font-size: 13px; color: #333; white-space: pre-wrap; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-top: 10px; }
      .badge { display: inline-block; border: 1px solid #aaa; border-radius: 999px; padding: 2px 10px; font-size: 12px; margin-right: 6px; }
      ul { margin: 8px 0 0 18px; }
      h1 { margin-bottom: 6px; }
      .hint { color: #666; margin-top: 0; }
    </style>
  </head>

  <body>
    <h1>AI Plot Hole Detector</h1>
    <p class="hint">Tip: Put a blank line between paragraphs for best “Analyze Paragraph” results.</p>

    <div class="row">
      <input id="docId" type="text" value="novel-ch1" />
      <button id="clipboardBtn">Analyze Clipboard</button>
      <button id="paraBtn">Analyze Paragraph</button>
      <button id="fullBtn">Analyze Full Text</button>
    </div>

    <textarea id="text" placeholder="Paste your scene here..."></textarea>

    <div class="status" id="status"></div>

    <h2>Issues</h2>
    <div id="issues"></div>

    <script>
      const API = "http://127.0.0.1:8000";

      const docIdEl = document.getElementById("docId");
      const textEl = document.getElementById("text");
      const statusEl = document.getElementById("status");
      const issuesEl = document.getElementById("issues");

      const clipboardBtn = document.getElementById("clipboardBtn");
      const paraBtn = document.getElementById("paraBtn");
      const fullBtn = document.getElementById("fullBtn");

      function setStatus(msg) {
        statusEl.textContent = msg || "";
      }

      function render(issues) {
        issuesEl.innerHTML = "";
        if (!issues || issues.length === 0) {
          issuesEl.innerHTML = `<div class="card">No issues found</div>`;
          return;
        }

        for (const it of issues) {
          const div = document.createElement("div");
          div.className = "card";

          const header = document.createElement("div");
          header.innerHTML = `
            <span class="badge">${escapeHtml(it.type)}</span>
            <span class="badge">${escapeHtml(it.severity)}</span>
          `;
          div.appendChild(header);

          const msg = document.createElement("div");
          msg.style.marginTop = "10px";
          msg.textContent = it.message || "";
          div.appendChild(msg);

          if (it.evidence && it.evidence.length) {
            const ul = document.createElement("ul");
            for (const ev of it.evidence) {
              const li = document.createElement("li");
              li.textContent = ev;
              ul.appendChild(li);
            }
            div.appendChild(ul);
          }

          issuesEl.appendChild(div);
        }
      }

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }

      function setBusy(isBusy) {
        clipboardBtn.disabled = isBusy;
        paraBtn.disabled = isBusy;
        fullBtn.disabled = isBusy;
      }

      async function callAnalyze(textToSend, label) {
        const docId = (docIdEl.value || "doc").trim() || "doc";

        setBusy(true);
        setStatus(`Analyzing (${label})...`);

        try {
          const res = await fetch(`${API}/analyze`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ docId, text: textToSend })
          });

          if (!res.ok) {
            const t = await res.text();
            throw new Error(`API ${res.status}: ${t}`);
          }

          const data = await res.json();
          render(data.issues);
          setStatus(`Done (${label}). Found ${data.issues.length} issue(s).`);
        } catch (e) {
          setStatus("Error: " + e.message);
        } finally {
          setBusy(false);
        }
      }

      // -------- Paragraph extraction --------
      // Defines "paragraph" as text between blank lines.
      // If no blank line exists, falls back to "line block" around cursor.
      function getParagraphAtCursor(fullText, cursorIndex) {
        const text = fullText.replace(/\r\n/g, "\n"); // normalize Windows newlines
        const i = Math.max(0, Math.min(cursorIndex ?? 0, text.length));

        // First try: paragraph separated by blank lines (one or more empty lines)
        // We'll search for \n\n boundaries around cursor.
        let start = text.lastIndexOf("\n\n", i - 1);
        let end = text.indexOf("\n\n", i);

        // Convert boundary indexes to actual paragraph range
        start = (start === -1) ? 0 : start + 2; // skip the delimiter
        end = (end === -1) ? text.length : end;

        let para = text.slice(start, end).trim();

        // If paragraph is still empty, fallback to "line block":
        // find nearest single newline boundaries
        if (!para) {
          let s2 = text.lastIndexOf("\n", i - 1);
          let e2 = text.indexOf("\n", i);
          s2 = (s2 === -1) ? 0 : s2 + 1;
          e2 = (e2 === -1) ? text.length : e2;
          para = text.slice(s2, e2).trim();
        }

        return para;
      }

      // -------- Buttons --------
      fullBtn.addEventListener("click", async () => {
        const text = textEl.value.trim();
        if (!text) return setStatus("Paste some text first.");
        await callAnalyze(text, "full text");
      });

      clipboardBtn.addEventListener("click", async () => {
        try {
          setStatus("Reading clipboard...");
          const clipText = await navigator.clipboard.readText();
          if (!clipText.trim()) return setStatus("Clipboard is empty. Copy something first.");
          textEl.value = clipText;
          await callAnalyze(clipText.trim(), "clipboard");
        } catch (e) {
          setStatus("Clipboard error: " + e.message);
        }
      });

      paraBtn.addEventListener("click", async () => {
        const full = textEl.value;
        if (!full.trim()) return setStatus("Paste some text first.");

        const cursor = textEl.selectionStart ?? 0;
        const para = getParagraphAtCursor(full, cursor);

        if (!para) {
          setStatus("No paragraph found. Tip: add a blank line between paragraphs.");
          return;
        }

        // Optional: show what paragraph we extracted (first 200 chars)
        const preview = para.length > 200 ? para.slice(0, 200) + "…" : para;
        setStatus(`Selected paragraph:\n${preview}\n\nAnalyzing...`);

        await callAnalyze(para, "paragraph");
      });
    </script>
  </body>
</html>
